<!-- REPORTES -->
<p-toast></p-toast>
<div class="min-h-screen bg-gray-100">
  <app-topbar></app-topbar>

  <div class="px-6 pt-1">
    <div class="flex justify-between items-center mt-1">
      <app-title [title]="'Documentos a pagar'" [subtitle]="'Sube o revisa documentos a pagar'"></app-title>
      <div class="flex gap-2">
        <button (click)="mostrarCardCrear = true" class="bg-sky-900 text-white py-2 px-4 rounded-md text-sm flex items-center justify-center gap-2 block mx-auto"><i class="pi pi-plus text-sm"></i>Crear</button>
        <button (click)="mostrarCardSubir = true" class="bg-sky-900 text-white py-2 px-4 rounded-md text-sm flex items-center justify-center gap-2 block mx-auto"><i class="pi pi-upload text-sm"></i>Subir en masa</button>
      </div>
    </div>
    
    <div class="flex justify-between mt-0 items-end" *ngIf="!mostrarTablaArchivos">
      <div class="flex gap-4">
        <div class="flex flex-col">
          <label for="fechaInicio" class="text-sm text-sky-900 font-medium mb-1">Fecha inicio</label>
          <p-calendar inputId="fechaInicio" [(ngModel)]="fechaInicio" dateFormat="yy-mm-dd" showIcon="true" class="w-full" />
        </div>
        <div class="flex flex-col">
          <label for="fechaFin" class="text-sm text-sky-900 font-medium mb-1">Fecha fin</label>
          <p-calendar inputId="fechaFin" [(ngModel)]="fechaFin" dateFormat="yy-mm-dd" showIcon="true" class="w-full" />
        </div>
      </div>

      <div class="flex gap-2">
        <button (click)="filtrarPorFechas()" class="bg-sky-900 text-white py-2 px-4 rounded-md text-sm flex items-center justify-center gap-2 block mx-auto"><i class="pi pi-filter text-sm"></i>Filtrar</button>
        <button (click)="descargarExcel()" class="bg-sky-900 text-white py-2 px-4 rounded-md text-sm flex items-center justify-center gap-2 block mx-auto"><i class="pi pi-file-excel text-sm"></i>Excel</button>
      </div>
    </div>

    
  </div>

  <!-- Tabla de reportes -->
  <div class="mt-2 px-6" >
    <div class="max-w-8xl mx-auto">
      <dx-data-grid
        *ngIf="!mostrarTablaArchivos"
        class="bg-white rounded-xl shadow-sm border border-gray-200"
        [dataSource]="products"
        keyExpr="idCarpeta"
        [selection]="{ mode: 'single' }"
        [showBorders]="false"
        [rowAlternationEnabled]="true"
        [columnAutoWidth]="true"
        [hoverStateEnabled]="true"
        [showColumnLines]="false"
        [showRowLines]="true"
        (onRowDblClick)="onVerClick($event)"
        (onRowUpdating)="onEditarDocumento($event)"
        noDataText="No hay elementos, ajusta tus filtros"
      >
      <dxo-paging [pageSize]="15"></dxo-paging>

      <dxo-pager
        [visible]="true"
        [allowedPageSizes]="[10, 15, 30, 50]"
        [displayMode]="'full'"
        [showPageSizeSelector]="true"
        [showInfo]="true"
        [showNavigationButtons]="true"
      >
      </dxo-pager>

        <dxo-editing
          mode="row"
          [allowUpdating]="true"
          [useIcons]="true"
        ></dxo-editing>

        <dxi-column type="buttons" [width]="60" caption="">
          <dxi-button name="edit" icon="edit"></dxi-button>
          <dxi-button name="save" icon="save"></dxi-button>
          <dxi-button name="cancel" icon="revert"></dxi-button>
        </dxi-column>

        <dxo-selection mode="single"></dxo-selection>

        <!-- Nombre con ícono tipo carpeta -->
        <dxi-column
          dataField="idCarpeta"
          [allowFiltering]="false"
          [allowSorting]="false"
          cellTemplate="cellTemplate"
          caption="Nombre"
          [width]="220"
        ></dxi-column>
        <div *dxTemplate="let data of 'cellTemplate'">
          <a
            #contextAnchor
            (click)="verDetalle(data.value)"
            (contextmenu)="onRightClick($event, data.value, cm)"
            class="flex items-center space-x-2 text-gray-700 hover:text-blue-700 font-medium cursor-pointer"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
              <path
                d="M2 4.5A1.5 1.5 0 0 1 3.5 3h5.672a1.5 1.5 0 0 1 1.06.44l1.828 1.828A1.5 1.5 0 0 0 13.12 6H16.5A1.5 1.5 0 0 1 18 7.5v7A1.5 1.5 0 0 1 16.5 16h-13A1.5 1.5 0 0 1 2 14.5v-10z"
              />
            </svg>
            <span class="truncate">{{ data.value }}</span>
          </a>
          <p-contextMenu 
            #cm 
            [model]="menuItems" 
            [target]="contextAnchor" 
            [baseZIndex]="10000"
            [appendTo]="'body'">
          </p-contextMenu>
        </div>

        <!-- Resto de columnas -->
        <dxi-column dataField="idCobrarPagoDoc" caption="CobrarPagarDoc"></dxi-column>
        <dxi-column dataField="idArea" caption="Área"></dxi-column>
        <dxi-column dataField="estado" caption="Estado"></dxi-column>
        <dxi-column dataField="revCtb" caption="Rev. Cont."></dxi-column>
        <dxi-column dataField="fechaVcto" caption="Fecha Vcto" dataType="date"></dxi-column>
        <dxi-column dataField="fechaPago" caption="Fecha Pago" dataType="date"></dxi-column>
        <dxi-column dataField="comentario" caption="Comentario"></dxi-column>
        <dxi-column dataField="revControl" caption="Rev. Control"></dxi-column>
        <dxi-column dataField="lca" caption="LCA"></dxi-column>
        <dxi-column dataField="documento" caption="Documento"></dxi-column>
        <dxi-column dataField="razonSocial" caption="Razón Social"></dxi-column>
        <dxi-column dataField="srIgv" caption="Src IGV"></dxi-column>
        <dxi-column dataField="tipoDet" caption="Tipo Det."></dxi-column>
        <dxi-column dataField="onsContable" caption="Ons Contable"></dxi-column>
        <dxi-column dataField="regimen" caption="Régimen"></dxi-column>
        <dxi-column dataField="importeBruto" caption="Importe Bruto" dataType="number"></dxi-column>
        <dxi-column dataField="impuestos" caption="Impuestos" dataType="number"></dxi-column>
        <dxi-column dataField="importeNeto" caption="Importe Neto" dataType="number"></dxi-column>
        <dxi-column dataField="moneda" caption="Moneda"></dxi-column>
        <dxi-column dataField="fechaProg" caption="Fecha Prog." dataType="date"></dxi-column>
        <dxi-column dataField="fechaEmision" caption="Fecha Emisión" dataType="date"></dxi-column>
        <dxi-column dataField="periodo" caption="Periodo"></dxi-column>
        <dxi-column dataField="tipoMovimiento" caption="Tipo Movimiento"></dxi-column>
        <dxi-column dataField="clasificacionLe" caption="Clasificación LE"></dxi-column>
        <dxi-column dataField="observacionesGlosa" caption="Observaciones"></dxi-column>
        <dxi-column dataField="fechaCreacion" caption="Fecha Creación" dataType="date"></dxi-column>
        <dxi-column dataField="fechaModificacion" caption="Fecha Modificación" dataType="date"></dxi-column>
      </dx-data-grid>

      <div *ngIf="mostrarTablaArchivos">
        <p-button label="Regresar" icon="pi pi-angle-left" variant="text" (click)="cerrarVistaArchivos()"></p-button>
      
        <div
          class="relative min-h-full"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onFileDrop($event)"
        >
          <!-- ZONA DE DROP -->
          <div
            class="absolute top-0 left-0 right-0 bottom-0 z-10 bg-white bg-opacity-70 border-4 border-dashed border-sky-600 flex items-center justify-center text-sky-700 font-semibold text-sm transition-opacity duration-200 pointer-events-none"
            [ngClass]="{ 'opacity-100': dropActive, 'opacity-0': !dropActive }"
          >
            Suelta los archivos aquí para subirlos
          </div>
        
          <dx-data-grid
            [dataSource]="archivosCarpeta"
            [columnAutoWidth]="true"
            [rowAlternationEnabled]="true"
            [hoverStateEnabled]="true"
            [showBorders]="false"
            [showColumnLines]="false"
            [showRowLines]="true"
            class="rounded-xl shadow-sm border border-gray-200 text-sm font-sans"
            (onRowDblClick)="abrirArchivo($event)"
            noDataText="Aquí no hay archivos, arrastra uno aquí"
          >
            <dxi-column
              dataField="name"
              caption="Nombre"
              cssClass="px-4 py-3 text-gray-800 font-medium"
            ></dxi-column>
          
            <dxi-column
              dataField="size"
              caption="Tamaño"
              [calculateCellValue]="formatSize"
              cssClass="px-4 py-3 text-gray-700"
            ></dxi-column>
          
            <dxi-column
              dataField="lastModified"
              caption="Última Modificación"
              dataType="date"
              cssClass="px-4 py-3 text-gray-600"
            ></dxi-column>

          </dx-data-grid>
        </div>
        
      
      </div>
  
    </div>
  </div>
</div>





<!-- Card flotante para 'Crear' -->
<p-dialog header="Crear documento" [(visible)]="mostrarCardCrear" [modal]="true" [style]="{width: '400px'}">
  <div class="flex flex-col gap-3 mt-1">

    <div class="flex flex-col">
      <label for="ruc" class="text-sm font-medium mb-1">RUC</label>
      <input id="ruc" pInputText [(ngModel)]="nuevoDocumento.ruc" class="w-full" />
    </div>

    <div class="flex gap-3">
      <div class="flex flex-col w-1/2">
        <label for="serie" class="text-sm font-medium mb-1">Serie</label>
        <input id="serie" pInputText [(ngModel)]="nuevoDocumento.serie" class="w-full" />
      </div>

      <div class="flex flex-col w-1/2">
        <label for="numero" class="text-sm font-medium mb-1">Número</label>
        <input id="numero" pInputText [(ngModel)]="nuevoDocumento.numero" class="w-full" />
      </div>
    </div>

    <div class="flex justify-end gap-2 mt-3">
      <button pButton label="Cancelar" (click)="mostrarCardCrear = false" class="p-button-secondary"></button>
      <button pButton label="Guardar" (click)="crearDocumento()" class="bg-sky-900 text-white py-2 px-4 rounded-md text-sm"></button>
    </div>

  </div>
</p-dialog>

<p-dialog header="Subir carpetas" [(visible)]="mostrarCardSubir" [modal]="true" [style]="{width: '600px'}">
  <div class="text-gray-700 text-sm mb-4">
    Arrastra carpetas o selecciónalas desde tu equipo
  </div>

  <div
    class="border-dashed border-2 border-gray-400 p-6 text-center cursor-pointer"
    (drop)="handleDrop($event)"
    (dragover)="allowDrop($event)">
    Arrastra carpetas aquí
  </div>

  <div *ngIf="estructuraCarpetas.length > 0" class="mt-4 max-h-64 overflow-y-auto border rounded p-3 bg-gray-50">
    <p class="text-sky-800 text-sm font-semibold mb-2">Estructura de carpetas:</p>
    <ul class="text-sm text-gray-700">
      <li *ngFor="let carpeta of estructuraCarpetas">
        📁 {{ carpeta.nombre }}
        <ul class="ml-4 list-disc mt-1">
          <li *ngFor="let archivo of carpeta.archivos">📄 {{ archivo }}</li>
        </ul>
      </li>
    </ul>
  </div>

  <div class="mt-4 flex justify-end gap-2">
    <button pButton label="Cancelar" icon="pi pi-times" class="p-button-secondary" (click)="cancelarSubida()"></button>
    <button (click)="subirCarpetas()"class="bg-sky-900 text-white py-2 px-4 rounded-md text-sm flex items-center justify-center gap-2 block "><i class="pi pi-upload text-sm"></i>Subir</button>
  </div>

</p-dialog>
