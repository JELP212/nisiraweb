<!-- REPORTES -->
<p-toast></p-toast>
<div class="min-h-screen bg-gray-100">
  <app-topbar></app-topbar>

  <div class="px-6 pt-1">
    <div class="flex justify-between items-center mt-1">
      <app-title [title]="'Documentos a pagar'" [subtitle]="'Sube o revisa documentos a pagar'"></app-title>
      <div class="flex gap-2">
        <button (click)="mostrarCardCrear = true" class="bg-sky-900 text-white py-2 px-4 rounded-md text-sm flex items-center justify-center gap-2 block mx-auto"><i class="pi pi-plus text-sm"></i>Crear</button>
        <button (click)="mostrarCardSubir = true" class="bg-sky-900 text-white py-2 px-4 rounded-md text-sm flex items-center justify-center gap-2 block mx-auto"><i class="pi pi-upload text-sm"></i>Subir en masa</button>
      </div>
    </div>
    
    <div class="flex justify-between mt-0 items-end" *ngIf="!mostrarTablaArchivos">

      <div class="flex gap-2">
        <button (click)="descargarExcel()" class="bg-sky-900 text-white py-2 px-4 rounded-md text-sm flex items-center justify-center gap-2 block mx-auto"><i class="pi pi-file-excel text-sm"></i>Excel</button>
      </div>
    </div>
    
  </div>

  <!-- Tabla de carpetas raíz -->
  <div class="mt-6 px-6">
    <div class="bg-white rounded-2xl shadow-md border border-gray-200 overflow-hidden">
      <div class="p-4" *ngIf="!mostrarTablaCarpetas">
        <p-button 
          label="Regresar" 
          icon="pi pi-angle-left" 
          variant="text" 
          (click)="verDetalle(carpetaActual.idCarpetaPadre)"
        ></p-button>
      </div>
      <table class="min-w-full divide-y divide-gray-200 text-sm text-left text-gray-800"
      *ngIf="!mostrarTablaCarpetas">
        <thead class="bg-gray-50 text-xs font-semibold text-gray-600 tracking-wider">
          <tr>
            <th class="px-6 py-3">Nombre</th>
            <th class="px-6 py-3">Fecha de Creación</th>
            <th class="px-6 py-3">Usuario</th>
            <th class="px-6 py-3">Fecha Modificación</th>
            <th class="px-6 py-3">Usuario Modificación</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          <tr 
            *ngFor="let carpeta of carpetasRaiz" 
            class="hover:bg-blue-50 cursor-pointer transition"
            (click)="verDetalle(carpeta.idCarpeta)"
          >
            <td *ngIf="!carpeta.esOrigen" class="px-6 py-4 font-medium">{{ carpeta.nombreCarpeta }}</td>
            <td *ngIf="!carpeta.esOrigen" class="px-6 py-4">{{ carpeta.fechaCreacion | date:'yyyy-MM-dd HH:mm' }}</td>
            <td *ngIf="!carpeta.esOrigen" class="px-6 py-4">{{ carpeta.usuarioCreador }}</td>
            <td *ngIf="!carpeta.esOrigen" class="px-6 py-4">
              {{ carpeta.fechaModificacion ? (carpeta.fechaModificacion | date:'yyyy-MM-dd HH:mm') : '-' }}
            </td>
            <td *ngIf="!carpeta.esOrigen" class="px-6 py-4">{{ carpeta.usuarioModif || '-' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  
  

  <!-- Tabla de reportes -->
  <div class="mt-2 px-6" >
    <div class="max-w-8xl mx-auto">
      <p-button 
      *ngIf=" mostrarTablaCarpetas"
      label="Regresar" icon="pi pi-angle-left" variant="text" (click)="cerrarVistaCarpeta()"></p-button>
      <dx-data-grid
        *ngIf="mostrarTablaCarpetas"
        class="bg-white rounded-xl shadow-sm border border-gray-200"
        [dataSource]="products"
        keyExpr="idCarpeta"
        [selection]="{ mode: 'single' }"
        [showBorders]="false"
        [rowAlternationEnabled]="true"
        [columnAutoWidth]="true"
        [hoverStateEnabled]="true"
        [showColumnLines]="false"
        [showRowLines]="true"
        (onRowDblClick)="onVerClick($event)"
        (onRowUpdating)="onEditarDocumento($event)"
        noDataText="No hay elementos, ajusta tus filtros"
      >
      <dxo-search-panel
        [visible]="true"
        [highlightCaseSensitive]="true"
      ></dxo-search-panel>
      <dxo-paging [pageSize]="100"></dxo-paging>
      <dxo-header-filter [visible]="true"></dxo-header-filter>
      <dxo-pager
        [visible]="true"
        [allowedPageSizes]="[100, 250, 500, 1000]"
        [displayMode]="'full'"
        [showPageSizeSelector]="true"
        [showInfo]="true"
        [showNavigationButtons]="true"
      >
      </dxo-pager>

        <dxo-editing
          mode="cell"
          [allowUpdating]="true"
          [useIcons]="true"
        ></dxo-editing>

        <dxi-column type="buttons" [width]="60" caption="">
          <dxi-button name="edit" icon="edit"></dxi-button>
          <dxi-button name="save" icon="save"></dxi-button>
          <dxi-button name="cancel" icon="revert"></dxi-button>
        </dxi-column>
        
        <dxo-selection mode="single"></dxo-selection>

        <!-- Nombre con ícono tipo carpeta -->
        <dxi-column
          dataField="idCarpeta"
          [allowFiltering]="true"
          [allowSorting]="false"
          cellTemplate="cellTemplate"
          caption="Nombre"
          [allowEditing]="false"
          [width]="220"
        >
        <dxo-header-filter [allowSelectAll]="false">
          <dxo-search [enabled]="true"></dxo-search>
        </dxo-header-filter>
      </dxi-column>
        
        <div *dxTemplate="let data of 'cellTemplate'">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
          <a
            #contextAnchor
            (click)="verArchivos(data.value)"
            (contextmenu)="onRightClick($event, data.value, cm)"
            class="flex items-center space-x-2 text-gray-700 hover:text-blue-700 font-medium cursor-pointer"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
              <path
                d="M2 4.5A1.5 1.5 0 0 1 3.5 3h5.672a1.5 1.5 0 0 1 1.06.44l1.828 1.828A1.5 1.5 0 0 0 13.12 6H16.5A1.5 1.5 0 0 1 18 7.5v7A1.5 1.5 0 0 1 16.5 16h-13A1.5 1.5 0 0 1 2 14.5v-10z"
              />
            </svg>
            <span class="truncate">{{ data.value }}</span>
          </a>
          <p-contextMenu 
            #cm 
            [model]="menuItems" 
            [target]="contextAnchor" 
            [baseZIndex]="10000"
            [appendTo]="'body'">
          </p-contextMenu>
        </div>

        <!-- Resto de columnas -->
        <dxi-column dataField="idCobrarPagoDoc" caption="CobrarPagarDoc">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
        </dxi-column>
        <dxi-column dataField="idArea" [width]="200" caption="Área">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
          <dxo-lookup [dataSource]="area" displayExpr="descripcion" valueExpr="id">
          </dxo-lookup>
        </dxi-column>
        <dxi-column dataField="estado" caption="Estado">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
        </dxi-column>
        <dxi-column dataField="revCtb" caption="Rev. Cont.">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
        </dxi-column>
        <dxi-column dataField="fechaVcto" caption="Fecha Vcto" dataType="date">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
        </dxi-column>
        <dxi-column dataField="fechaPago" caption="Fecha Pago" dataType="date">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
        </dxi-column>
        <dxi-column dataField="comentario" caption="Comentario">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
        </dxi-column>
        <dxi-column dataField="revControl" caption="Rev. Control">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
          <dxo-lookup [dataSource]="rev" displayExpr="descripcion" valueExpr="idRev">
          </dxo-lookup>
        </dxi-column>
        <dxi-column dataField="lca" caption="LCA">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
        </dxi-column>
        <dxi-column dataField="documento" caption="Documento">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
        </dxi-column>
        <dxi-column dataField="razonSocial" caption="Razón Social">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
        </dxi-column>
        <dxi-column dataField="srIgv" caption="Sr IGV">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
          <dxo-lookup [dataSource]="igv" displayExpr="descripcion" valueExpr="idigv">
          </dxo-lookup>
        </dxi-column>
        <dxi-column dataField="tipoDet" [width]="200" caption="Tipo Det.">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
          <dxo-lookup [dataSource]="tipoDet" displayExpr="descripcion" valueExpr="id">
          </dxo-lookup>
        </dxi-column>
        <dxi-column dataField="onsContable" caption="Obs Contable">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
          <dxo-lookup [dataSource]="obs" displayExpr="descripcion" valueExpr="idObs">
          </dxo-lookup>
        </dxi-column>
        <dxi-column dataField="regimen" caption="Régimen">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
          <dxo-lookup [dataSource]="regimen" displayExpr="descripcion" valueExpr="idRegimen">
          </dxo-lookup>
        </dxi-column>
        <dxi-column dataField="importeBruto" caption="Importe Bruto" dataType="number">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
        </dxi-column>
        <dxi-column dataField="impuestos" caption="Impuestos" dataType="number">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
          <dxo-lookup [dataSource]="impuestos" displayExpr="descripcion" valueExpr="idImpuestos">
          </dxo-lookup>
        </dxi-column>
        <dxi-column dataField="importeNeto" caption="Importe Neto" dataType="number">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
        </dxi-column>
        <dxi-column dataField="moneda" caption="Moneda">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
          <dxo-lookup [dataSource]="moneda" displayExpr="descripcion" valueExpr="idMoneda">
          </dxo-lookup>
        </dxi-column>
        <dxi-column dataField="fechaProg" caption="Fecha Prog." dataType="date">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
        </dxi-column>
        <dxi-column dataField="fechaEmision" caption="Fecha Emisión" dataType="date">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
        </dxi-column>
        <dxi-column dataField="periodo" caption="Periodo">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
        </dxi-column>
        <dxi-column dataField="tipoMovimiento" [width]="200" caption="Tipo Movimiento">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
          <dxo-lookup [dataSource]="tipoMovimiento" displayExpr="descripcion" valueExpr="id">
          </dxo-lookup>
        </dxi-column>
        <dxi-column dataField="clasificacionLe" [width]="200" caption="Clasificación LE">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
          <dxo-lookup [dataSource]="clasificacionLE" displayExpr="descripcion" valueExpr="id">
          </dxo-lookup>
        </dxi-column>
        <dxi-column dataField="observacionesGlosa" caption="Observaciones">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
        </dxi-column>
        <dxi-column dataField="fechaCreacion" caption="Fecha Creación" dataType="date">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
        </dxi-column>
        <dxi-column dataField="fechaModificacion" caption="Fecha Modificación" dataType="date">
          <dxo-header-filter [allowSelectAll]="false">
            <dxo-search [enabled]="true"></dxo-search>
          </dxo-header-filter>
        </dxi-column>
      </dx-data-grid>

      <p-drawer [header]="carpetaSeleccionada ? 'Archivos en: ' + carpetaSeleccionada : 'Archivos'" 
          [(visible)]="mostrarTablaArchivos"
          (onHide)="cerrarVistaArchivos()"
          position="right"
          styleClass="!w-full md:!w-80 lg:!w-[30rem]">

    <ng-template pTemplate="content">
        <div class="relative h-full flex flex-col p-3"
             (dragover)="onDragOver($event)"
             (dragleave)="onDragLeave($event)"
             (drop)="onFileDrop($event)">

            <div class="absolute top-0 left-0 right-0 bottom-0 z-10 bg-white bg-opacity-80 border-4 border-dashed border-sky-600 flex items-center justify-center text-sky-700 font-semibold text-lg transition-opacity duration-200 pointer-events-none"
                 [ngClass]="{ 'opacity-100': dropActive, 'opacity-0': !dropActive }">
                <i class="pi pi-upload text-3xl mr-2"></i> Suelta los archivos aquí para subirlos
            </div>

            <div class="flex-grow flex flex-col">

                <div *ngIf="cargandoArchivos" class="flex-grow flex items-center justify-center">
                    <p-progressSpinner strokeWidth="4" animationDuration=".5s" styleClass="w-12 h-12"></p-progressSpinner>
                    </div>

                <div *ngIf="!cargandoArchivos" class="archivos-list overflow-y-auto flex-grow pt-2">
                    <div *ngIf="archivosCarpeta && archivosCarpeta.length > 0; else noArchivosTemplateDrawer">
                      <p-card *ngFor="let archivo of archivosCarpeta"
                              styleClass="mb-1 shadow-md hover:shadow-lg transition-shadow duration-200" (click)="verArchivo(archivo.url, archivo.name)">
                          <ng-template pTemplate="title">
                              <div class="flex items-center">
                                  <i class="pi pi-file mr-1 text-lg text-gray-600"></i> <span class="truncate text-base font-semibold" [title]="archivo.name">{{ archivo.name }}</span> </div>
                          </ng-template>
                          <ng-template pTemplate="content">
                              <div class="flex justify-between text-sm text-gray-700 mt-1">
                                  <span class="mr-2"> {{ formatSize(archivo) }}</span>
                                  <span> {{ archivo.lastModified | date:'dd/MM/yyyy HH:mm' }}</span>
                              </div>
                          </ng-template>
                      </p-card>
                    </div>

                    <ng-template #noArchivosTemplateDrawer>
                        <div class="text-center py-10 text-gray-500" *ngIf="!dropActive">
                            <i class="pi pi-inbox text-4xl mb-3"></i>
                            <p class="font-semibold">Aquí no hay archivos.</p>
                            <p class="text-sm">Arrastra y suelta archivos en esta área para subirlos.</p>
                        </div>
                    </ng-template>
                </div>
            </div>
        </div>
    </ng-template>

</p-drawer>

<p-dialog header="Visor de archivo" [(visible)]="mostrarVisor" [modal]="true" [style]="{width: '80vw'}" [closable]="true" [resizable]="false">
  <div class="flex justify-between items-center mb-4">
    <h3 class="text-lg font-semibold">{{ archivoSeleccionadoNombre }}</h3>
      <button pButton type="button" icon="pi pi-download" label="Descargar"
        class="p-button-sm p-button-success"
        (click)="descargarArchivo()"></button>

  </div>

  <ng-container *ngIf="archivoSeleccionadoUrl">
    <img *ngIf="esImagen(archivoSeleccionadoUrl)" [src]="archivoSeleccionadoUrl" style="max-width: 100%; max-height: 70vh;" />

    <iframe *ngIf="esPDF(archivoSeleccionadoUrl)" [src]="archivoSeleccionadoUrl" width="100%" height="500px"></iframe>

    <iframe *ngIf="esWord(archivoSeleccionadoUrl)" [src]="'https://docs.google.com/gview?url=' + archivoSeleccionadoUrl + '&embedded=true'" width="100%" height="500px"></iframe>

    <p *ngIf="!esImagen(archivoSeleccionadoUrl) && !esPDF(archivoSeleccionadoUrl) && !esWord(archivoSeleccionadoUrl)">
      Tipo de archivo no soportado para vista previa.
    </p>
  </ng-container>
</p-dialog>

  
    </div>
  </div>
</div>





<!-- Card flotante para 'Crear' -->
<p-dialog header="Crear documento" [(visible)]="mostrarCardCrear" [modal]="true" [style]="{width: '400px'}">
  <div class="flex flex-col gap-3 mt-1">

    <div class="flex flex-col">
      <label for="ruc" class="text-sm font-medium mb-1">RUC</label>
      <input id="ruc" pInputText [(ngModel)]="nuevoDocumento.ruc" class="w-full" />
    </div>

    <div class="flex gap-3">
      <div class="flex flex-col w-1/2">
        <label for="serie" class="text-sm font-medium mb-1">Serie</label>
        <input id="serie" pInputText [(ngModel)]="nuevoDocumento.serie" class="w-full" />
      </div>

      <div class="flex flex-col w-1/2">
        <label for="numero" class="text-sm font-medium mb-1">Número</label>
        <input id="numero" pInputText [(ngModel)]="nuevoDocumento.numero" class="w-full" />
      </div>
    </div>

    <div class="flex justify-end gap-2 mt-3">
      <button pButton label="Cancelar" (click)="mostrarCardCrear = false" class="p-button-secondary"></button>
      <button pButton label="Guardar" (click)="crearDocumento()" class="bg-sky-900 text-white py-2 px-4 rounded-md text-sm"></button>
    </div>

  </div>
</p-dialog>

<p-dialog header="Subir carpetas" [(visible)]="mostrarCardSubir" [modal]="true" [style]="{width: '600px'}">
  <div class="text-gray-700 text-sm mb-4">
    Arrastra carpetas o selecciónalas desde tu equipo
  </div>

  <div
    class="border-dashed border-2 border-gray-400 p-6 text-center cursor-pointer"
    (drop)="handleDrop($event)"
    (dragover)="allowDrop($event)">
    Arrastra carpetas aquí
  </div>

  <div *ngIf="estructuraCarpetas.length > 0" class="mt-4 max-h-64 overflow-y-auto border rounded p-3 bg-gray-50">
    <p class="text-sky-800 text-sm font-semibold mb-2">Estructura de carpetas:</p>
    <ul class="text-sm text-gray-700">
      <li *ngFor="let carpeta of estructuraCarpetas">
        📁 {{ carpeta.nombre }}
        <ul class="ml-4 list-disc mt-1">
          <li *ngFor="let archivo of carpeta.archivos">📄 {{ archivo }}</li>
        </ul>
      </li>
    </ul>
  </div>

  <div class="mt-4 flex justify-end gap-2">
    <button pButton label="Cancelar" icon="pi pi-times" class="p-button-secondary" (click)="cancelarSubida()"></button>
    <button (click)="subirCarpetas()"class="bg-sky-900 text-white py-2 px-4 rounded-md text-sm flex items-center justify-center gap-2 block "><i class="pi pi-upload text-sm"></i>Subir</button>
  </div>

</p-dialog>
