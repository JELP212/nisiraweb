<!-- REPORTES -->
<p-toast></p-toast>
<div class="min-h-screen bg-gray-100">
  <app-topbar></app-topbar>

  <div class="px-6 py-4">
    <div class="flex justify-between items-center mt-4">
      <app-title [title]="'Inicio'" [subtitle]="'Revisa tus reportes guardados'"></app-title>
      <div class="flex gap-2">
        <button (click)="mostrarCardCrear = true" class="bg-sky-900 text-white py-2 px-4 rounded-md text-sm flex items-center justify-center gap-2 block mx-auto"><i class="pi pi-plus text-sm"></i>Crear</button>
        <button (click)="mostrarCardSubir = true" class="bg-sky-900 text-white py-2 px-4 rounded-md text-sm flex items-center justify-center gap-2 block mx-auto"><i class="pi pi-upload text-sm"></i>Subir en masa</button>
      </div>
    </div>
    
    <!-- Filtros de fecha -->
    <!-- Filtros de fecha -->
<div class="flex justify-between mt-4 items-end">
  <!-- Calendarios -->
  <div class="flex gap-4">
    <div class="flex flex-col">
      <label for="fechaInicio" class="text-sm text-sky-900 font-medium mb-1">Fecha inicio</label>
      <p-calendar inputId="fechaInicio" [(ngModel)]="fechaInicio" dateFormat="yy-mm-dd" showIcon="true" class="w-full" />
    </div>
    <div class="flex flex-col">
      <label for="fechaFin" class="text-sm text-sky-900 font-medium mb-1">Fecha fin</label>
      <p-calendar inputId="fechaFin" [(ngModel)]="fechaFin" dateFormat="yy-mm-dd" showIcon="true" class="w-full" />
    </div>
  </div>

  <!-- Botones -->
  <div class="flex gap-2">
    <button (click)="filtrarPorFechas()" class="bg-sky-900 text-white py-2 px-4 rounded-md text-sm flex items-center justify-center gap-2 block mx-auto"><i class="pi pi-filter text-sm"></i>Filtrar</button>
    <button (click)="descargarExcel()" class="bg-sky-900 text-white py-2 px-4 rounded-md text-sm flex items-center justify-center gap-2 block mx-auto"><i class="pi pi-file-excel text-sm"></i>Excel</button>
  </div>
</div>

    
  </div>

  <!-- Tabla de reportes -->
  <div class="mt-6 px-6" >
    <div class="max-w-8xl mx-auto">
      <p-table *ngIf="!mostrarTablaArchivos" [value]="products" [(selection)]="selectedProduct" dataKey="idCarpeta" selectionMode="single" [tableStyle]="{'min-width': '50rem'}">
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 3rem">
            </th>
            <th>Ver</th>
            <th>Empresa</th>
            <th>Carpeta</th>
            <th>CobrarPagarDoc</th>
            <th>Area</th>
            <th>Estado</th>
            <th>RevCont</th>
            <th>Fecha Vcto</th>
            <th>Fecha Pago</th>
            <th>Comentario</th>
            <th>RevControl</th>
            <th>Lca</th>
            <th>Documento</th>
            <th>Razón Social</th>
            <th>SrcIgv</th>
            <th>TipoDet</th>
            <th>OnsContable</th>
            <th>Regimen</th>
            <th>Importe Bruto</th>
            <th>Impuestos</th>
            <th>Importe Neto</th>
            <th>Moneda</th>
            <th>Fecha Prog</th>
            <th>Fecha Emisión</th>
            <th>Periodo</th>
            <th>Tipo Movimiento</th>
            <th>ClasificacionLe</th>
            <th>ObservacionesGlosa</th>
            <th>Fecha Creación</th>
            <th>Fecha Modificación</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-product>
          <tr [pSelectableRow]="product">
            <td>
              <p-checkbox 
                [binary]="true"
                [ngModel]="selectedProduct === product"
                (onChange)="onCheckboxChange(product)">
              </p-checkbox>
            </td>
            <td>
              <button pButton pRipple icon="pi pi-eye" class="p-button-text" (click)="verDetalle(product.idCarpeta)"></button>
            </td>
            <td>{{ product.idEmpresa }}</td>
            <td>{{ product.idCarpeta }}</td>
            <td>{{ product.idCobrarPagoDoc }}</td>
            <td>{{ product.idArea }}</td>
            <td>{{ product.estado }}</td>
            <td>{{ product.revCtb }}</td>
            <td>{{ product.fechaVcto }}</td>
            <td>{{ product.fechaPago }}</td>
            <td>{{ product.comentario }}</td>
            <td>{{ product.revControl }}</td>
            <td>{{ product.lca }}</td>
            <td>{{ product.documento }}</td>
            <td>{{ product.razonSocial }}</td>
            <td>{{ product.srIgv }}</td>
            <td>{{ product.tipoDet }}</td>
            <td>{{ product.onsContable }}</td>
            <td>{{ product.regimen }}</td>
            <td>{{ product.importeBruto }}</td>
            <td>{{ product.impuestos }}</td>
            <td>{{ product.importeNeto }}</td>
            <td>{{ product.moneda }}</td>
            <td>{{ product.fechaProg }}</td>
            <td>{{ product.fechaEmision }}</td>
            <td>{{ product.periodo }}</td>
            <td>{{ product.tipoMovimiento }}</td>
            <td>{{ product.clasificacionLe }}</td>
            <td>{{ product.observacionesGlosa }}</td>
            <td>{{ product.fechaCreacion }}</td>
            <td>{{ product.fechaModificacion }}</td>
          </tr>
        </ng-template>
      </p-table>
      <div *ngIf="mostrarTablaArchivos">
        <p-button label="Cerrar" icon="pi pi-times" class="p-button-danger mb-3" (click)="cerrarVistaArchivos()"></p-button>
  
        <p-table [value]="archivosCarpeta" [tableStyle]="{'min-width': '50rem'}">
          <ng-template pTemplate="header">
            <tr>
              <th>Nombre</th>
              <th>Tamaño</th>
              <th>Última Modificación</th>
              <th>Enlace</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-archivo>
            <tr>
              <td>{{ archivo.name }}</td>
              <td>{{ archivo.size | number }} bytes</td>
              <td>{{ archivo.lastModified | date:'medium' }}</td>
              <td><a [href]="archivo.url" target="_blank">Ver Archivo</a></td>
            </tr>
          </ng-template>
        </p-table>
      </div>
  
    </div>
  </div>
</div>


<!-- Card flotante para 'Crear' -->
<p-dialog header="Crear documento" [(visible)]="mostrarCardCrear" [modal]="true" [style]="{width: '400px'}">
  <div class="flex flex-col gap-3 mt-2">
    <input pInputText placeholder="RUC" [(ngModel)]="nuevoDocumento.ruc">
    <input pInputText placeholder="Serie" [(ngModel)]="nuevoDocumento.serie">
    <input pInputText placeholder="Número" [(ngModel)]="nuevoDocumento.numero">
    <div class="flex justify-end gap-2 mt-4">
      <button pButton label="Cancelar" (click)="mostrarCardCrear = false" class="p-button-secondary"></button>
      <button (click)="crearDocumento()" class="bg-sky-900 text-white py-2 px-4 rounded-md text-sm flex items-center">Guardar</button>
    </div>
  </div>
</p-dialog>

<p-dialog header="Subir carpetas" [(visible)]="mostrarCardSubir" [modal]="true" [style]="{width: '600px'}">
  <div class="text-gray-700 text-sm mb-4">
    Arrastra carpetas o selecciónalas desde tu equipo
  </div>

  <div
    class="border-dashed border-2 border-gray-400 p-6 text-center cursor-pointer"
    (drop)="handleDrop($event)"
    (dragover)="allowDrop($event)">
    Arrastra carpetas aquí
  </div>

  <div class="mt-4 flex justify-end gap-2">
    <button (click)="subirCarpetas()"class="bg-sky-900 text-white py-2 px-4 rounded-md text-sm flex items-center justify-center gap-2 block "><i class="pi pi-upload text-sm"></i>Subir</button>
    <button pButton label="Cancelar" icon="pi pi-times" class="p-button-secondary" (click)="cancelarSubida()"></button>
  </div>

  <div *ngIf="estructuraCarpetas.length > 0" class="mt-4 max-h-64 overflow-y-auto border rounded p-3 bg-gray-50">
    <p class="text-sky-800 text-sm font-semibold mb-2">Estructura de carpetas:</p>
    <ul class="text-sm text-gray-700">
      <li *ngFor="let carpeta of estructuraCarpetas">
        📁 {{ carpeta.nombre }}
        <ul class="ml-4 list-disc mt-1">
          <li *ngFor="let archivo of carpeta.archivos">📄 {{ archivo }}</li>
        </ul>
      </li>
    </ul>
  </div>
</p-dialog>
